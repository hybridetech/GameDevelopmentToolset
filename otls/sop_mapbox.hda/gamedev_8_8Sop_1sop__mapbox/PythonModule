from PySide2 import QtWebEngineWidgets, QtWidgets
import urllib
import os 
from math import sin, cos, sqrt, atan2, radians
import time 
# approximate radius of earth in km
R = 6371.0

    
def latlong_distance(lat_long_1, lat_long_2):
    lat1 = radians(lat_long_1[0])
    lon1 = radians(lat_long_1[1])
    lat2 = radians(lat_long_2[0])
    lon2 = radians(lat_long_2[1])

    dlon = lon2 - lon1
    dlat = lat2 - lat1

    a = sin(dlat / 2)**2 + cos(lat1) * cos(lat2) * sin(dlon / 2)**2
    c = 2 * atan2(sqrt(a), sqrt(1 - a))

    distance = R * c
    return distance * 1000

def update(node):
    launch_map()
    #time.sleep(3)
    hou.session.mapbox_web.urlChanged.connect(url_changed)


def url_changed(new_url):
    print new_url
    url = (new_url.url())
    post_hash = url.split("#")
    print len(post_hash[1].split(","))
    if len(post_hash[1].split(",")) == 7:
        
        on_button(hou.session.mapbox_web, hou.session.mapbox_node)
        
def on_button(test, node):
    url = (test.url().toString())
    post_hash = url.split("#")
    if len(post_hash) == 1:
        return 
    print "ob button"
    lon, lat, zoom, ne_lat, ne_lon , sw_lat , sw_lon  = post_hash[1].split(",")
  
    node.parm("lat_lon_zoomx").set(float(lat))
    
    node.parm("lat_lon_zoomy").set(float(lon))
    
    node.parm("lat_lon_zoomz").set(float(zoom))
    
    node.parm("boundsx").set(float(ne_lat))
    node.parm("boundsy").set(float(ne_lon))
    node.parm("boundsz").set(float(sw_lat))
    node.parm("boundsw").set(float(sw_lon))
    
    distance = latlong_distance([float(ne_lat), float(sw_lon)], [float(sw_lat), float(sw_lon)])
    distance2 = latlong_distance([float(ne_lat), float(ne_lon)], [float(ne_lat), float(sw_lon)])

    node.parm("total_size").set(max(distance, distance2))
    refresh(node, force=True)   
    hou.session.mapbox_win.close()


def refresh(node, force=True):
    
    lat = node.parm("lat_lon_zoomx").eval()
    lon = node.parm("lat_lon_zoomy").eval()
    zoom = node.parm("lat_lon_zoomz").eval()
    
    cache_lat = node.parm("cache_lat_lon_zoomx").eval()
    cache_lon = node.parm("cache_lat_lon_zoomy").eval()
    cache_zoom = node.parm("cache_lat_lon_zoomz").eval()
    
    if lat != cache_lat or lon != cache_lon or zoom != cache_zoom or force:
        
        node.parm("cache_lat_lon_zoomx").set(lat)
        node.parm("cache_lat_lon_zoomy").set(lon)
        node.parm("cache_lat_lon_zoomz").set(zoom)
        
        
        ne_lat = node.parm("boundsx").eval()
        ne_lon = node.parm("boundsy").eval()
        sw_lat = node.parm("boundsz").eval()
        sw_lon = node.parm("boundsw").eval()
    
        terrain = "https://api.mapbox.com/v4/mapbox.terrain-rgb/" + str(lon) +"," + str(lat) + "," + str((zoom+2)) + "/1024x1024@2x.png?access_token=" + node.parm("api_key").eval()
        color_url = "https://api.mapbox.com/styles/v1/mapbox/satellite-v9/static/" + str(lon) + "," + str(lat) + "," + str((zoom+1)) + "/1024x1024@2x?access_token="+ node.parm("api_key").eval()
        osm_url = "https://overpass-api.de/api/map?bbox=" + str(sw_lon) + "," + str(sw_lat) + "," + str(ne_lon) + "," + str(ne_lat)

        print color_url
        terrain_path = node.parm("download_path_height").eval()
        terrain_dir = os.path.dirname(terrain_path)
        if not os.path.exists(terrain_dir):
            os.makedirs(terrain_dir)
        
        color_path = node.parm("download_path_color").eval()
        color_dir = os.path.dirname(color_path)
        if not os.path.exists(color_dir):
            os.makedirs(color_dir)
        
            
        osm_path = node.parm("download_path_osm").eval()
        osm_dir = os.path.dirname(osm_path)
        if not os.path.exists(osm_dir):
            os.makedirs(osm_dir)

        
        urllib.urlretrieve(terrain, terrain_path)
        urllib.urlretrieve(color_url, color_path)
        
        urllib.urlretrieve(osm_url, osm_path)
    
    
    node.node("cop2net1/input_file").parm("reload").pressButton()
    node.node("load_sat_image_as_color").parm("reload").pressButton()
    node.node('load_in_osm_data/read_in_map_data').cook(force=True)
    node.node('load_in_osm_data').bypass(True)
    node.node('load_in_osm_data').bypass(False)
    
    hou.hscript("glcache -c;") #refresh textures

def launch_map():

    node = hou.pwd()
    
    win = QtWidgets.QWidget()
    win.setWindowTitle('Image List')
    win.setMinimumSize(550, 580)
    win.setMaximumSize(550,580)
    layout = QtWidgets.QVBoxLayout()
    win.setLayout(layout)
    webview = QtWebEngineWidgets.QWebEngineView()
    lat = node.parm("lat_lon_zoomx").eval()
    lon = node.parm("lat_lon_zoomy").eval()
    zoom = node.parm("lat_lon_zoomz").eval()
    webview.setUrl(os.environ["HOUDINI_USER_PREF_DIR"] + "/mapbox/mapbox_map.html#" + str(lon) + "," + str(lat) + "," + str(zoom) + "," + node.parm("api_key").eval())
    
    layout.addWidget(webview)
    
    button = QtWidgets.QPushButton("Download")
    button.clicked.connect(lambda: on_button(webview, node))
    layout.addWidget(button)
    
    hou.session.mapbox_win = win 
    hou.session.mapbox_web = webview 
    hou.session.mapbox_node = node
    
    win.show()
        